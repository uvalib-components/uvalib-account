<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">

<link rel="import" href="uvalib-account-app.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <uvalib-auth></uvalib-auth>

@demo demo/auth.html
@hero hero.svg
-->

<dom-module id="uvalib-account-auth">
  <template>
    <app-location query-params="{{_queryParams}}"></app-location>
    <app-localstorage-document  log key="uvalib-auth-user" data="{{_userMeta}}"></app-localstorage-document>
    <firebase-auth id="auth" on-error="_handleError" signed-in="{{signedIn}}" user="{{user}}"></firebase-auth>
  </template>
  <script>
    Polymer({
      is: 'uvalib-account-auth',

      properties: {

        auto: {
          type: Boolean,
          value: false
        },

        /**
         * Used to bind the url query from the app-location element for use in getting the
         * firebase token and user info from the server.
         */
        _queryParams: {
          type: Object,
          value: null,
          notify: true,
          observer: '_setUser'
        },

        /**
          * True if the client is authenticated, and false if the client is not
          * authenticated for Firebase (Library API) use.
          */
        signedIn: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * The currently-authenticated user with user-related metadata. See
         * the [`firebase.User`](https://firebase.google.com/docs/reference/js/firebase.User)
         * documentation for the spec.
         */
        user: {
          type: Object,
          notify: true,
          computed: '_getUser(_userMeta)'
        },

        /**
         * LDAP info about the user, this is identifying information and should be handled with care
         * the latest firebase token is also stored here
         */
//        _userMeta: {
//          type: Object
//        },

        /**
         * Firebase token
         */
        _fireToken: {
          type: String,
          computed: '_getToken(_queryParams)',
          observer: '_fbSignIn',
        }

      },

      /**
       * Attempts to sign in to firebase with token if not already signed in
       *
       * @return {Promise} Promise that handles success and failure.
       */
      _fbSignIn: function(){
        if (!this.signedIn && this._fireToken) {
          return this.$.auth.signInWithCustomToken(this._fireToken);
        }
      },

      /**
       * Redirects the user to authenticate with UVA Netbadge, which will redirect to the current url with a token and user info
       */
      signInWithNetbadge: function(){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/fireauth/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0]);
        }
      },
      /**
       * Redirects the user to authenticate with a UVA Library PIN, limited attempts, then redirects to the current url with a token and user info
       */
      signInWithPin: function(uid, pin){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/commuser/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0])+"&login="+encodeURIComponent(uid)+"&pin="+encodeURIComponent(pin);
        }
      },

      /**
       * Unauthenticates a Firebase client.
       *
       * @return {Promise} Promise that handles success and failure.
       */
      signOut: function() {
        this.set('_queryParams',{});
        this.set('_userMeta',{});
        return this.$.auth.signOut();
      },

      _getToken: function() {
        //_queryParams, _userMeta
        if (this._queryParams && this._queryParams.hasOwnProperty('token') && this._queryParams.token) {
          return this._queryParams.token;
        } else {
          return null;
        }
      },

      _setUser: function(){
        // the query parameters have changed, see if there is user info and update the user object if so
        if (this._queryParams && this._queryParams.id && this._queryParams.user) {
          var user = JSON.parse(this._queryParams.user);
          var newUser={};
          if (user.computingId) newUser.computingId = user.computingId;
          if (user.givenName && user.givenName.length>0) newUser.givenName = user.givenName;
          if (user.surName && user.surName.length>0) newUser.surName = user.surName;
          if (user.organizationalUnit && user.organizationalUnit.length>0) newUser.orgUnit = user.organizationalUnit;
          if (user.profile && user.profile.length>0) newUser.profile = user.profile;
          if (user.email && user.email.length>0) newUser.email = user.email;
          if (user.phone && user.phone.length>0) newUser.phone = user.phone;
          this.set('user',newUser);
        }
      },

      _getUser: function(){
        return this._userMeta;
      },

      ready: function(){}

    });
  </script>
</dom-module>
