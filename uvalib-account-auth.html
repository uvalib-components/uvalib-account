<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../uvalib-helper-libs/lodash.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <uvalib-auth></uvalib-auth>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="uvalib-account-auth">
  <template>
    <app-location query-params="{{_queryParams}}" ></app-location>
    <app-localstorage-document key="user" data="{{userMeta}}"></app-localstorage-document>
  </template>
  <script>
    Polymer({
      is: 'uvalib-account-auth',

      behaviors: [
        Polymer.FirebaseCommonBehavior
      ],

      properties: {

        accountInfo: {
          type: Object,
          notify: true
        },

        _queryParams: {
          type: Object,
          notify: true
        },

        /**
         * [`firebase.Auth`](https://firebase.google.com/docs/reference/js/firebase.auth.Auth) service interface.
         */
        auth: {
          type: Object,
          computed: '_computeAuth(app)',
          observer: '__authChanged',
          notify: true
        },

        /**
          * True if the client is authenticated, and false if the client is not
          * authenticated.
          */
        signedIn: {
          type: Boolean,
          computed: '_computeSignedIn(user)',
          notify: true
        },

        /**
         * The currently-authenticated user with user-related metadata. See
         * the [`firebase.User`](https://firebase.google.com/docs/reference/js/firebase.User)
         * documentation for the spec.
         */
        user: {
          type: Object,
          notify: true
        },

        token: {

        },

        userMeta: {
          type: Object,
          notify: true
        }

      },

      signInWithNetbadge: function(){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/fireauth/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0]);
        }
      },
      signInWithPin: function(uid, pin){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/commuser/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0])+"&login="+encodeURIComponent(uid)+"&pin="+encodeURIComponent(pin);
        }
      },
      /**
       * Unauthenticates a Firebase client.
       *
       * @return {Promise} Promise that handles success and failure.
       */
      signOut: function() {
        if (!this.auth) {
          return Promise.reject('No app configured for auth!');
        }
        this.set('userMeta',{});
        return this.auth.signOut();
      },
      _computeSignedIn: function(user) {
        return !!user;
      },
      _computeAuth: function(app) {
        return this.app.auth();
      },
      __authChanged: function(auth, oldAuth) {
        if (oldAuth !== auth && this._unsubscribe) {
          this._unsubscribe();
          this._unsubscribe = null;
        }
        if (this.auth) {
          this._unsubscribe = this.auth.onAuthStateChanged(function(user) {
            this.set('user',user);

            if (user) {
              this.fire('authenticated',user);
            }
          }.bind(this), function(err) {
            this.fire('error', err);
          }.bind(this));
        }
      },
      ready: function(){
        if (this._queryParams && !_.isEmpty(this._queryParams)) {
          var token = this._queryParams.token;
          var cid = this._queryParams.id;

          if (token)
            this.auth.signInWithCustomToken(token).then(function(){
              if (this._queryParams.user) {
                this.set('userMeta',this._userMetaCleanup(JSON.parse(this._queryParams.user).user));
                console.log('setup the userMeta data from url');
              }
              this._queryParams = {};
            }.bind(this));
        }

      },

      _userMetaCleanup: function(meta){
        return _.mapValues(_.omit(meta,['$']), function(o){
          if (Array.isArray(o) && o.length === 1) return o[0];
          else return o;
        });
      }

    });
  </script>
</dom-module>
