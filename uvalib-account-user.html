<link rel="import" href="uvalib-account-auth.html">
<link rel="import" href="../uva-helper-libs/lil-uuid.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<dom-module id="uvalib-account-user">
  <template>
      <firebase-document id="doc" path="[[_createPath(user)]]" data="{{_userData}}"></firebase-document>
      <app-indexeddb-mirror key="lib-user-data" data="{{_userData}}" persisted-data="{{userData}}"></app-indexeddb-mirror>
<!--
      <firebase-document id="libReq" path="[[_createRequestPath(_requestUuid)]]" data="{{_requestDetails}}"></firebase-document>
      <firebase-document id="libReqPatronCopy" path="[[_createUserRequestPath(_requestUuid,user)]]" data="{{_requestDetails}}"></firebase-document>
-->
      <app-indexeddb-mirror key="lib-user-request-data" data="{{_requestDetails}}" persisted-data="{{requestDetails}}"></app-indexeddb-mirror>
  </template>

  <script>
    /**
     * `uvalib-account-user`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/auth-user-info.html
     * @demo demo/auth-user-props.html
     */
    class UvalibAccountUser extends UvalibAccountAuth {
      static get is() { return 'uvalib-account-user'; }
      static get properties() {
        return Object.assign(super.properties,{
          _userData: Object,
          userData: {
            type: Object,
            notify: true,
            value: function(){return {};}
          },
          _requestDetails: Object,
          requestDetails: {
            type: Object,
            notify: true,
            value: function(){return {};}
          },
          libStaff: {
            type: Boolean,
            notify: true,
            computed: '_isStaff(userData)'
          },
          /**
           * Contact information needed by request forms:
           * computingID, name, email, affiliation, and department/school
           */
          contactInfo: {
            type: Object,
            notify: true,
            computed: '_getContactInfo(userData)'
          },
          _requestUuid: {
            type: String
          }
        });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibAccountAuth.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-account-user', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      _createPath(user){
        if (user)
          return "/users/"+user.uid;
        else {
          return null;
        }
      }
      _createRequestPath(_requestUuid){
        if (_requestUuid != '')
          return "/requests/"+_requestUuid;
        else {
          return null;
        }
      }
      _createUserRequestPath(_requestUuid,user){
        if (user && _requestUuid != '') {
          return "/users/"+user.uid+"/requests/"+_requestUuid;
        } else {
          return null;
        }
      }
      _isStaff(userData){
        if (userData && userData.LDAP && userData.LDAP.uvaDisplayDepartment)
          return (userData.LDAP.uvaDisplayDepartment === "University of Virginia Library"
                  || userData.LDAP.uvaDisplayDepartment.toLowerCase().includes("univ librarian")
                  || userData.LDAP.uvaDisplayDepartment.toLowerCase().includes("lb-"));
      }
      _getContactInfo(userData){
        var contactInfo = {computing_id: '', name: '', email: '', phone: '', affiliation: '', department_school: '', processed_dept_school: ''};
        if (userData && userData.LDAP) {
          var prefName, prefEmail, status, deptSchool;
          contactInfo.computing_id = this.userData.LDAP.uid;
          contactInfo.name = userData.LDAP.givenName + ' ' + userData.LDAP.sn;
          contactInfo.email = (userData.LDAP.preferredemailaddress) ? userData.LDAP.preferredemailaddress : userData.LDAP.mail;
          if (userData.LDAP.edupersonprimaryaffiliation) {
            contactInfo.affiliation = userData.LDAP.edupersonprimaryaffiliation
          } else if (userData.LDAP.uvaPersonIAMAffiliation) {
            contactInfo.affiliation = userData.LDAP.uvaPersonIAMAffiliation[0];
          } else {
            contactInfo.affiliation = userData.LDAP.edupersonaffiliation[0];
          }
          if (contactInfo.affiliation.includes('student')) {
            if (userData.LDAP.uvaRegistrarSchool) {
              contactInfo.department_school = userData.LDAP.uvaRegistrarSchool;
              contactInfo.processed_dept_school = this._processDepartmentSchool(userData.LDAP.uvaRegistrarSchool);
            } else if (userData.LDAP.uvaDisplayDepartment) {
              contactInfo.department_school = userData.LDAP.uvaDisplayDepartment;
              contactInfo.processed_dept_school = this._processDepartmentSchool(userData.LDAP.uvaDisplayDepartment);
            } else if (userData.LDAP.uvaOracleDeptName) {
              contactInfo.department_school = userData.LDAP.uvaOracleDeptName;
              contactInfo.processed_dept_school = this._processDepartmentSchool(userData.LDAP.uvaOracleDeptName);
            }
            contactInfo.phone = (userData.LDAP.mobile) ? userData.LDAP.mobile : '';
          } else {
            if (userData.LDAP.uvaDisplayDepartment) {
              contactInfo.department_school = userData.LDAP.uvaDisplayDepartment;
              contactInfo.processed_dept_school = this._processDepartmentSchool(userData.LDAP.uvaDisplayDepartment);
            } else if (userData.LDAP.uvaOracleDeptName) {
              contactInfo.department_school = userData.LDAP.uvaOracleDeptName;
              contactInfo.processed_dept_school = this._processDepartmentSchool(userData.LDAP.uvaOracleDeptName);
            }
            if (userData.LDAP.telephoneNumber) {
              contactInfo.phone = userData.LDAP.telephoneNumber;
            } else if (userData.LDAP.mobile) {
              contactInfo.phone = userData.LDAP.mobile;
            }
          }
        }
        return contactInfo;
      }
      _processDepartmentSchool(ldapValue) {
        // Strip out that initial code at the start of the department
        var dept = ldapValue.replace(/^[A-Z0-9]{2}:/,''); //substring(ldapValue.indexOf(':')+1);
        console.log(dept);
        // Throw away words that won't match our department list...
        // school of , dept of, graduate, visiting, 'vp for', etc.
      	dept = dept.replace(/(Institute of|(Curry |McIntire ){0,1}School of|Department (of|for)|University of Virginia|Museum|VP for|Visiting)/,'');
        dept = dept.replace(/(Language(s){0,1} and Literatures|Languages(, Literatures,){0,1} and Cultures)/,'');
        dept = dept.replace(/(Graduate|Undergraduate)/,'');
        // Remap certain department names to completely different ones.
      	if ((dept == 'Virginia Center for Transportation Innovation and Research') || (dept == 'Civil & Env Engr')) {
      		dept = 'Civil Eng. and Applied Mathematics';
      	} else if (dept == 'American Studies') {
      		dept = 'English';
      	} else if (dept == 'Centers for Computation Research & Scholarship') {
      		dept = 'Computer Science';
      	} else if (dept.indexOf('Batten ') > -1) {
      		dept = 'Batten School';
      	} else if (dept.indexOf('Germanic') > -1) {
      		dept = 'German';
      	} else if (dept.indexOf('Mechanical and Ae') > -1) {
      		dept = 'Mechanical and Aerospace Engineering';
      	} else if (dept.indexOf('Urban and Environmental Planning') > -1) {
      		dept = 'Architecture';
      	} else if ((dept == 'Papers of James Madison') || (dept.indexOf('Woodson Institute') > -1)) {
      		dept = 'History';
      	} else if (dept == 'Office of the Vice Prov for Instructional Dev') {
      		dept = 'Education';
      	}
        console.log(dept);
        return dept;
      }
      saveRequest(formSubmission) {
        this._requestUuid = lil.uuid();
        this._requestDetails = {
          "uid": (this.user && this.user.uid) ? this.user.uid : null,
          "timestamp": {".sv": "timestamp"},
          "submission": JSON.stringify(formSubmission)
        };
        var promises = [];
        promises.push(firebase.database().ref(this._createRequestPath(this._requestUuid)).set(this._requestDetails));
        if (this.user)
          promises.push(firebase.database().ref(this._createUserRequestPath(this._requestUuid,this.user)).set(this._requestDetails));
        return Promise.all(promises);
      }
    }

    window.customElements.define(UvalibAccountUser.is, UvalibAccountUser);
  </script>
</dom-module>
