<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-app.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <uvalib-auth></uvalib-auth>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="uvalib-auth">
  <template>
    <firebase-app auth-domain="uvalib-mobile.firebaseapp.com" database-url="https://uvalib-mobile.firebaseio.com" api-key="AIzaSyACyEdD3xp2Ys_QWY6izvMHX2JO6GfUBck"></firebase-app>
  </template>
  <script>
    Polymer({
      is: 'uvalib-auth',

      behaviors: [
        Polymer.FirebaseCommonBehavior
      ],

      properties: {

        /**
         * [`firebase.Auth`](https://firebase.google.com/docs/reference/js/firebase.auth.Auth) service interface.
         */
        auth: {
          type: Object,
          computed: '_computeAuth(app)',
          observer: '__authChanged'
        },

        /**
          * True if the client is authenticated, and false if the client is not
          * authenticated.
          */
        signedIn: {
          type: Boolean,
          computed: '_computeSignedIn(user)',
          notify: true
        },

        /**
         * The currently-authenticated user with user-related metadata. See
         * the [`firebase.User`](https://firebase.google.com/docs/reference/js/firebase.User)
         * documentation for the spec.
         */
        user: {
          type: Object,
          readOnly: true,
          value: null,
          notify: true
        }

      },

      signInWithNetbadge: function(){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/fireauth/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0]);
        }
      },
      signInWithPin: function(uid, pin){
        if (!this.signedIn) {
          window.location = "https://api.library.virginia.edu/commuser/hello.js?dest="+encodeURIComponent(window.location.href.split('?')[0])+"&login="+encodeURIComponent(uid)+"&pin="+encodeURIComponent(pin);
        }
      },
      /**
       * Unauthenticates a Firebase client.
       *
       * @return {Promise} Promise that handles success and failure.
       */
      signOut: function() {
        if (!this.auth) {
          return Promise.reject('No app configured for auth!');
        }
        return this.auth.signOut();
      },
      _computeSignedIn: function(user) {
        return !!user;
      },
      _computeAuth: function(app) {
        return this.app.auth();
      },
      __authChanged: function(auth, oldAuth) {
        if (oldAuth !== auth && this._unsubscribe) {
          this._unsubscribe();
          this._unsubscribe = null;
        }
        if (this.auth) {
          this._unsubscribe = this.auth.onAuthStateChanged(function(user) {
            this._setUser(user);
          }.bind(this), function(err) {
            this.fire('error', err);
          }.bind(this));
        }
      },
      ready: function(){
        var params = new URLSearchParams(location.search);
        var token = params.get("token"),
            cid = params.get("id");
        if (token)
        this.auth.signInWithCustomToken(token);
      }

    });
  </script>
</dom-module>
